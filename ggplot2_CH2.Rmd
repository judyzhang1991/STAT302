---
title: "ggplot2_CH2"
author: "Jingyang(Judy) Zhang"
date: "3/31/2020"
output: html_document
---
# CH2 Getting Started with ggplot2 #

## 2.1 Introduction ##
```{r}
library(tidyverse)
library(reshape)
library(ggpubr)
```


## 2.2 Fuel Economy Data ##
```{r}
mpg
dat=mpg
```

- ``cty``: miles per gallon (mpg) for city driving

- ``hwy``: miles per gallon (mpg) for highway driving

- ``displ``: engine displacement in liters

- ``drv``: drivetrain: fromt wheel (f), rear wheel (r), or four whell (4)

- ``model``: model of car: 38 models, selected as they had a new edition every year btw 1999 and 2008

- ``class``: a categ variable describing the "type" if car: two seater, SUV, compact, etc. 


RQ1: Q5: Using the ``mpg`` dataset, what is the mean number of city miles per gallon for all vehicles from 2008? Round to two decimal places. 

```{r}
mpg %>% 
  filter(year==2008) %>%
  summarise(
    mean_cty=mean(cty)
  )
```


RQ1: Q7 Which variable is being mapped to the color aesthetic from the ``mpg`` dataset?

```{r}
unique(mpg$model)

ggplot(mpg, aes(displ, hwy, color=model))+
  geom_point()

unique(mpg$drv)
ggplot(mpg, aes(displ, hwy, color=drv))+
  geom_point()

unique(mpg$manufacturer)

ggplot(mpg, aes(displ, hwy, color=manufacturer))+
  geom_point()

unique(mpg$cyl)

ggplot(mpg, aes(displ, hwy, color=cyl))+
  geom_point()
```


RQ1: Q8 In the ``mpg`` dataset, which variable would be best to use for size aesthetics when plotting points (i.e. scatterplot) with ``cty`` as the $x$ variable and hwy as the $y$ variable?


```{r}


ggplot(mpg, aes(cty, hwy, size=displ))+
  geom_point()


```




### 2.2.1 Exercises ###
1. List five functions that you could use to get more information about the ``mpg`` dataset.

mean(), median(), sd(), plot(), histogram

2. How can you find out what other datasets are included with ggplot2? 
Use google search to find the reference page of the ggplot2 official website. Other datasets included with ggplot2 are ``diamonds``, ``economics``, ``economics_long``, ``midwest``, etc. 

3. Aprt from the US, most countries use fuel consumption (fuel consumed over fixed distance) rather than fuel economy (distance travelled with fixed amount of fuel). How could you convert ``cty`` and ``hwy`` intro the European standard of $1/100$km? 

First, mpg is fuel economy as it measures the distance (miles) travelled with fixed amount of fuel (per gallon). 
Assume we have $x$ mpg, to convert it to $1/100$ km, we have:

1 gallon correspond to $x$ miles $\Rightarrow$ 1 gallon correspond to $1.609x$ km $\Rightarrow$ $\frac{100}{1.609x}\times 1$ per $100$ km. 


4. Which manufacturer has the most models in this dataset? Which model has the most variations? Does your answer change if you remove the redundant specification of drive train (e.g. "pathfinder 4wd", "a4 quattro") from the model name?

```{r}
ggplot(dat, aes(x=as.factor(manufacturer)))+
  geom_bar()+
  geom_text(stat = 'count',aes(label =..count.., vjust = -0.2))
```

Dodge has the most models in this dataset. 

!!! Does your answer change if you remove the redundant specification of drive train (e.g. "pathfinder 4wd", "a4 quattro") from the model name? !!!
```{r}
ggplot(dat, aes(x=as.factor(model)))+
  geom_bar()+
  geom_text(stat = 'count',aes(label =..count.., vjust = -0.2))+
  theme(axis.text.x=element_text(angle=90, hjust=1, size=7))
```


## 2.3 Key Components ##
1. Every ggplot2 has three key components:

a. Data (supplied in ``ggplot()``)

b. Aesthetic Mappings: a set of aesthetic mappings between variables in the data and visual properties (supplied in ``ggplot()``)

c. Layer: at least one layer which describes how to render each observation. Layers are usually created with a \textbf{geom} function (add to a ``ggplot()`` using ``+``)


2. Example
```{r}
ggplot(mpg, aes(x=displ, y=hwy))+
  geom_point()
```

a. Data: mpg

b. Aesthetic Mappings: engine size (``displ``) mapped to x position; fuel economy on highway (``hwy``) mapped to y position

c. Layer: points

d. The plot shows a strong correlation: as the engine size gets bigger, the fuel economy gets worse. There are also some outliers: some cars with large engines get higher fuel economiy than average (Hybrid car??). 


3. The first two unnamed arguments to ``aes()``: will be mapped to x and y. 


### 2.3.1. Exercises ###
1. How would you describe the relationship between ``cty`` and ``hwy``? Do you have any concerns about drawing conclusions from that plot?

```{r}
ggplot(mpg, aes(cty, hwy))+geom_point()+
  theme(axis.text.x=element_text(angle=90, hjust=1, size=7))
```

The relationship between ``cty`` and ``hwy`` should be strongly positively correlated which means the higher fuel economy when driving in the city correspond to higher fuel economy when driving on highway. 

Concerns about drawing conclusions from just a scatter plot are:

??????????


2. What does ``ggplot(mpg, aes(model, manufacturer))+geom_point()`` show? Is it useful? How could you modify the data to make it more informative?

```{r}
ggplot(mpg, aes(model, manufacturer))+
  geom_point()+
  theme(axis.text.x=element_text(angle=90, hjust=1, size=7))
  


```


The plot shows a scatter plot with model mapped to x position and manufacturer mapped to y position. It shows model and its corresponding manufacturer. It is not very useful as the information can be obtained by looking at the data itself. 

To make it more useful, we can modify the data by grouping ???

3. Describe the data, aesthetic mappings and layers used for each of the following plots. You will need to guess a little because you have not seen all the datasets and functions yet, but use your common sense. See if you can predict what the plot will look like before running the code. 
a. ``ggplot(mpg, aes(cty, hwy))+geom_points()``:

(1) Data: mpg

(2) Aesthetic Mappings: fuel economy when driving in the city (``cty``) mapped to x position and fuel economy when driving on highway (``hwy``) mapped to y position

(3) Layer: points


b. ``ggplot(diamonds, aes(carat, price))+geom_point()``:

(1) Data: diamonds

(2) Aesthetic Mappings: carat of diamonds (``carat``) mapped to x position and price of diamonds (``price``) mapped to y position

(3) Layer: points


c. ``ggplot(economics, aes(date, unemploy))+geom_line()``:

(1) Data: economics

(2) Aesthetic Mappings: date (``date``) mapped to x position and a measure of unemployment such as unemployment rate (``unemploy``) mapped to y position

(3) Layer: line


d. ``ggplot(mpg, aes(cty))+geom_histogram()``:

(1) Data: mpg

(2) Aesthetic Mappings: fuel economy when driving in the city (``cty``) is mapped to x position, corresponding frequency of the values of the fuel economy when driving in the city (``cty``) is mapped to y position

(3) Layer: histogram



## 2.4 Colour, Size, Shape and Other Aesthetic Attributes ##
1. Other aesthetics that can be added to ``aes()``:

a. color

b. shape

c. size

etc.

These work in the same way as ``x`` and ``y`` aesthetics, and are added into the call to ``aes()``:

```{r}
ggplot(dat, aes(displ, hwy, color=class, shape=drv, size=cyl))+
  geom_point()
```

2. Scale: map values in the data space to values in the aesthetic space (color, size, shape, etc.). Scales are reported on the plot using axes and legends.

a. Scales do have a big effect on the visual appearance of the plot, but the dominant way of visual appearance is theme command.

b. Take experience ot know when you change scale and when the theme:

(1) Rule of Thumb: themes do NOT add words and change ranges of variables, they change the font, size, color, etc. 


3. To learn more about the outlying variables (e.g. cars with large engines but with higher fuel economy than average) in the ``ggplot(mpg, aes(x=displ, y=hwy))+geom_point()``, use the following plot:
```{r}
ggplot(mpg, aes(displ, cty, color=class))+
  geom_point()

```

a. ``color=class``: gives each point a unique color corresponding to its class. 

b. The group of cars with unusually high fuel economy for their engine size are: two seaters (cars with big engines but light weight bodies).

?????????????
4. If want to set an aesthetic to a fixed value, without scaling it, do so in the individual layer outside of ``aes()``:

```{r}
ggplot(mpg, aes(displ, hwy))+
  geom_point(aes(color="blue"))
```
????????
The value "blue" is scaled to a pinkish color, and a legend is added. 


```{r}
ggplot(mpg, aes(displ, hwy))+
  geom_point(color="blue")
```

The points are given the R color blue. 


5. Different types of aesthetic attributes work better with different types of variables:

a. Categorical Variables: color, shape, etc. 

v. Continuous Variables: size, etc. 


6. The amount of data also makes a difference: if there is a lot of data, it can be hard to distinguish different groups. 

Solution: use facetting. 



### 2.4.1 Exercises ###

1. Experiment with the color, shape and size aesthetics. What happens when you map them to continous values? What about categorical values? What happens when you use more than one aesthetic in a plot?

a. Map color, shape, size to continuous values; Use more than one aesthetic in a plot
```{r error=TRUE}
ggplot(mpg, aes(displ, hwy, aes(color=cty, shape=cty, size=hwy)))+
  geom_point()
# Nothing gets mapped

ggplot(mpg, aes(displ, hwy))+
  geom_point(aes(color=cty, shape=cty, size=hwy))

# Error: A continuous variable can not be mapped to shape


##### EUIQVALENT #####
ggplot(mpg, aes(displ, hwy))+
  geom_point(aes(color=cty, size=hwy))

ggplot(mpg, aes(displ, hwy))+
  geom_point(aes(color=cty, size=hwy))
# No error, able to map but not very informative


```

b. Map color, shape, size to categorical values

```{r}
ggplot(mpg, aes(displ, hwy, color=manufacturer, shape=drv))+
  geom_point()
```



2. What happens if you map a continuous variable to shape? Why? What happens if you map ``trans`` to shape? Why?

Map to a continuous variable to shape will result in an error because shape is discrete not continuous. 


Map ``trans`` to shape
```{r}
ggplot(mpg, aes(displ, hwy, shape=trans))+
  geom_point()

unique(mpg$trans)
```
Get warning messages because the shape palette can deal with a maximum of 6 discrete values and ``trans`` has 10 distinct values. 


3. How is drive train related to fuel economy? How is drive train related to engine size and class? 

?????????? Fuel economy =hwy and cty???
Drive Train v.s. Fuel Economy
```{r}


```

Drive Train v.s. Engine Size v.s. Class
```{r}
ggplot(mpg, aes(class, displ, color=drv))+
  geom_point()+
  theme(axis.text.x=element_text(angle=90, hjust=1, size=7))
```


## 2.5 Facetting ##

1. Facetting: another technique for displaying additional categorical variables on a plot. Facetting creates tables of graphics by splitting the data into subsets and displaying the sam egraph for each subset. 

a. Two Type of Facetting

(1) Grid

(2) Wrapped (most useful): to facet a plot, add a facetting specification with ``facet_wrap()`` which takes the name of a varible preceded by ``~``.

```{r}
ggplot(mpg, aes(displ, hwy))+
  geom_point()+
  facet_wrap(~class)
```


### 2.5.1 Exercises ###

1. What happens if you try to facet by a continuous variable like ``hwy``? What about ``cyl``? What's the key difference?

Facet by a continuous variable
```{r}
ggplot(mpg, aes(displ, hwy))+
  geom_point()+
  facet_wrap(~hwy)
```
Facet by ``hwy`` will treat the continuous variable ``hwy`` as categorical variable. As ``hwy`` is a continuous variable with many distinct values, the plot treats each distinct value as a level of a categorical variable and creates a plot for it. The result will be many plots with little information provided in each plot. 

Facet by ``cyl``
```{r}

ggplot(mpg, aes(displ, hwy))+
  geom_point()+
  facet_wrap(~cyl)

```
The difference in that ``cyl`` is categorical  with only 4 levels. The result will be more informative as it shows the relationshipbetween ``hwy`` and ``displ`` for each level of ``cyl``. 

2. Use facetting to explore the three-way relationship between fuel economy, engine size, and number of cylinders. How does facetting by number of cylinders change your assessment of the relationship between engine size and fuel economy?

```{r}

ggplot(mpg, aes(displ, hwy))+
  geom_point()+
  facet_wrap(~cyl)

```
Facetting by number of cylinders shows that the relationship between engine size and fuel economy is different for different number of cylinders. 

3. Read the documentation for ``facet_wrap()``. What arguments can you use to control how many rows and columns appear in the output?
The arguments that control how many rows and columns are ``nrows`` and ``ncols``.

```{r}
ggplot(mpg, aes(displ, hwy))+
  geom_point()+
  facet_wrap(~cyl, nrow=1, ncol=4)
```


4. What does the ``scales`` argument to ``facet_wrap()`` do? When might you use it? 

The ``scales`` argument decides if the scales should be fixed ("fixed", default) or free ("free"), or free in onde dimention ("free_x","free_y").

The default "fixed" means the same scales are used for all panels. 

"free" allows scales to vary across the panels, it will be easier to see patterns within each panel but harder to compare across panels. 

```{r}
ggplot(mpg, aes(displ, hwy))+
  geom_point()+
  facet_wrap(~cyl, scales="free")
# Each panel will have different scales for x-axis and y-axis. 
```




## 2.6 Plot Geoms ##

1. Commonly used plot types:

a. ``geom_smooth()``: fits a smoother to the data and displays the smooth and its standard error. It adds a smoothing line to see the trand of points. The standard error is represented as a band covering the smoothing line. 

b. ``geom_boxplot()``: produces a box-and-whisker plot to summarise the distribution of a set of points. 

c. ``geom_histogram()``: shows the distribution of continuous variables.

d. ``geom_freqpoly``: shows the distribution of continuous variables. 

e. ``geom_bar()``: shows the distribution of categorical variables. 

f. ``geom_path()``: draws lines between the data points. A path plot can go in any direction. 

h. ``geom_line()``: draws lines between the data points. A line plot is constrained to produce lines that travel from left to right. Lines are typically used to explore how things change over time. 


### 2.6.1. Adding a Smoother to a Plot ###

1. Adding a smoothing line/curve to a scatterplot with a lot of noise can help to see the dominant pattern. 

```{r}
ggplot(mpg, aes(displ, hwy))+
  geom_point()+
  geom_smooth()
```

``geom_smooth()`` overlays the scatterplot with a smooth curve, including an assessment of uncertainty in the form of point-wise confidence intervals shown in grey. 

a. ``geom_smooth(se=FALSE)``: will turn off the confidence interval. 


2. ``method`` argument to ``geom_smooth()``: allows you to choose which type of model is used to fit the smooth curve:

a. ``method="loess"``: the default for small $n (n<1000)$ as it is $O(n^{2})$ in memory. It uses a smooth local regression.

(1) ``span`` parameter: control the wiggliness of the line. It ranges from $0$ (extremely wiggly) to $1$ (not so wiggly). 

```{r}
# No need to specify method="loess" as it is the default
ggplot(mpg, aes(displ, hwy))+
  geom_point()+
  geom_smooth(span=0.2)

ggplot(mpg, aes(displ, hwy))+
  geom_point()+
  geom_smooth(span=1)
```


b. ``method="gam"``: method used for small $n (n<1000)$ or large $n (n\geq 1000)$. It fits a generalized additive model provided by the ``mgcv`` package (thus need to first load the package). It uses a formula like ``formula=y~s(x)`` or ``y~s(x, bs="cs")`` (for large data). 
```{r}
library(mgcv)

ggplot(mpg, aes(displ, hwy))+
  geom_point()+
  geom_smooth(method="gam", formula=y~s(x))
```



c. ``method="lm"``: fits a lienar model giving the line of best fit. 
```{r}
ggplot(mpg, aes(displ, hwy))+
  geom_point()+
  geom_smooth(method="lm")
```


d. ``method="rlm"``: works like ``lm()``, but uses a robust fitting algorithm so that outliers dont affect the fits as much. It is part of the ``MASS`` package (thus need to be loaded before using).
```{r}
library(MASS)

ggplot(mpg, aes(displ, hwy))+
  geom_point()+
  geom_smooth(method="rlm")
```



### 2.6.2 Boxplots and Jittered Points ###

1. Three Techniques for Alleviating Overplotting (i.e. many points are plotted in the same location s.t. it's difficult to see the dist):

a. Jittering ``geom_jitter()``: adds a little random noise to the data which can help avoid overplotting. 

(1) Strength & Weakness: jittered plots show every pt but only work with relatively small datasets. 

b. Boxplots ``geom_boxplot()``: summarises the shape of the dist with a handful of summary statistics: min, max, first quartile (25th percentile; Q1), median (50th percentile; Q2), third quartile (75th percentile; Q3). 

(1) Strength & Weakness: boxplots summarise the bulk of the dist with only 5 numbers.

Interquartile Range (IQR)=Q3-Q1=$q_{n}(0.75)-q_{n}(0.25)$.

c. Violoin plots ``geom_violin``: shows a compact representation of the "density" of the dist, highlighting the areas where more points are found. 

(1) Strength & Weakness: violin plots give the richest display but rely on the cal of a density estimate, which can be hard to interpret. 

```{r}
jitter=ggplot(mpg, aes(drv, hwy))+geom_jitter()
box=ggplot(mpg, aes(drv, hwy))+geom_boxplot()
violin=ggplot(mpg, aes(drv, hwy))+geom_violin()

ggarrange(jitter, box, violin + rremove("x.text"), 
          labels = c("Jittering", "Boxplot", "Violin Plot"),
          ncol = 2, nrow = 2)

```

2. For jittered points: ``geom_jitter()`` offers the same control over aesthetics as ``geom_point()``: ``size``, ``color``, ``shape``. 


3. For ``geom_boxplot()`` and ``geom_violin()``: can control the outline ``color`` or the internal ``fill`` color. 


### 2.6.3. Histogram and Frequency Polygons ###
